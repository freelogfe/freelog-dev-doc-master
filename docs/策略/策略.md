## 策略

- #### report(contract) 策略翻译

  | 参数名   | 参数类型     | 参数含义   | 说明                                                   |
  | -------- | ------------ | ---------- | ------------------------------------------------------ |
  | contract | StateMachine | 策略状态机 | 即下面的compile(...)接口返回值中的${state_machine}字段 |
  
- #### transfer(states, fsmTransfers) 扭转记录翻译

  | 参数名       | 参数类型      | 参数含义     | 说明                                                         |
  | ------------ | ------------- | ------------ | ------------------------------------------------------------ |
  | states       | States        | 状态机状态   | 即下面的compile(...)接口返回值中的${state_machine.states}字段 |
  | fsmTransfers | FsmTransfer[] | 扭转记录集合 | FsmTransfer：{<br>state: string; // 当前状态<br>fromState?: string; // 从哪个状态来的，如果填null，表示该状态为起始状态<br>isFirst?: boolean; // 是否是第一条扭转记录<br>toState: string; // 到哪个状态去的，如果填null，表示该扭转记录为当前最后一个记录<br>isLast?: boolean; // 是否是最后一条扭转记录<br>time: string; // 扭转到该状态时的时间字符串，将根据此字段排序<br>event: EventEntity; // 当前状态下发生过的事件，若没有，则填null值<br>} |

  扭转记录：

  ```json
  [
      {
          toState: "auth",
          time: "2022-03-02 00:00:00",
          event: {
              "toState": "auth_month",
              "service": "freelog",
              "name": "TransactionEvent",
              "args": {
                  "amount": 10,
                  "account": "self.account"
              },
              "code": "S201",
              "description": "one time transaction",
              "isSingleton": true
          }
      }, {
          toState: "auth_month",
          time: "2022-03-03 00:00:00",
          event: {
              "toState": "auth_year",
              "service": "freelog",
              "name": "TransactionEvent",
              "args": {
                  "amount": 100,
                  "account": "self.account"
              },
              "code": "S201",
              "description": "one time transaction",
              "isSingleton": true
          }
      }, {
          toState: "auth_year",
          isLast: true,
          time: "2022-03-03 00:00:00",
          event: {
              "toState": "finish",
              "service": "freelog",
              "name": "RelativeTimeEvent",
              "args": {
                  "elapsed": 1,
                  "timeUnit": "year"
              },
              "code": "A103",
              "description": "fired when certain amount of time elapsed",
              "isSingleton": false
          }
      }
  ]
  ```

  返回结构：

  ```
  {
    fsmTransferResults: [
      {
        stateStr: '未授权 2022-03-02 00:00:00',
        stateInfoStr: '',
        eventStr: '',
        eventSelectStr: '',
        eventSectionStrs: []
      },
      {
        stateStr: '已授权 2022-03-03 00:00:00',
        stateInfoStr: '已支付 10枚 羽币，进入 状态auth_month，获得授权',
        eventStr: '',
        eventSelectStr: '',
        eventSectionStrs: []
      },
      {
        stateStr: '已授权 2022-03-03 00:00:00',
        stateInfoStr: '已支付 100枚 羽币，进入 状态auth_year，获得授权',
        eventStr: '1年之后，将进入 状态finish，合约将自动终止',
        eventSelectStr: '',
        eventSectionStrs: []
      }
    ],
    content: '· 未授权 2022-03-02 00:00:00\n' +
      '· 已授权 2022-03-03 00:00:00\n' +
      '  已支付 10枚 羽币，进入 状态auth_month，获得授权\n' +
      '· 已授权 2022-03-03 00:00:00\n' +
      '  已支付 100枚 羽币，进入 状态auth_year，获得授权\n' +
      '  > 1年之后，将进入 状态finish，合约将自动终止\n'
  }
  ```

  

- #### compareRoutes(route, routes, options) 比较路由

  | 参数名  | 参数类型                   | 参数含义               | 说明                                                         |
  | ------- | -------------------------- | ---------------------- | ------------------------------------------------------------ |
  | routes  | FSMRouteElement[] []       | 路由元素               | FSMRouteElement：{state: string; serviceStates: string[]; event: EventEntity;}<br>EventEntity：{id?: string; name: string; args?: {}; state?: string;} |
  | routesB | FSMRouteElement[] []       | 路由元素B              |                                                              |
  | options | CompareRoutesOptions(可选) | 比较路由参数选项(可选) | CompareRoutesOptions：{// 是否做参数校验 0:否 1:是 eventArgs: number; // 是否做色块校验 0:否 1:是 2:包含 serviceStates: number;} |

- #### parseRoutes(states, stateName, routes, route) 解析路由

  | 参数名    | 参数类型             | 参数含义         | 说明                               |
  | --------- | -------------------- | ---------------- | ---------------------------------- |
  | states    |                      | 状态机           | 就是编译结果中的状态机，参考md文档 |
  | stateName | string               | 起始状态名       |                                    |
  | routes    | FSMRouteElement[] [] | 路由集合（结果） |                                    |
  | route     | FSMRouteElement[]    | 路由             |                                    |

- ####compile(policyText, targetType, targetUrl, env) 编译

  | 参数名     | 参数类型 | 参数含义       | 说明 |
  | ---------- | -------- | -------------- | ---- |
  | policyText | string   | 编译文本       |      |
  | targetType | string   | 标的物类型     |      |
  | targetUrl  | string   | 远端地址       |      |
  | env        | string   | 环境:dev\|prod |      |

  输入结构：
  
  ```json
  for public
  
  initial[active]:
  ~freelog.RelativeTimeEvent("1","week") => auth  // 设置试用周期
  auth:
  ~freelog.TransactionEvent("10","self.account") => auth_month  // 设置包月价格
  ~freelog.TransactionEvent("100","self.account") => auth_year  // 设置包年价格
  ~freelog.RelativeTimeEvent("3","day")  =>  finish
  auth_month[active]:
  ~freelog.RelativeTimeEvent("1","month")  =>  finish // 设置订阅周期为一个月
  ~freelog.TransactionEvent("100","self.account") => auth_year  // 设置包年价格
  auth_year[active]:
  ~freelog.RelativeTimeEvent("1","year")  =>  finish  // 设置订阅周期为一个年
  finish:
  terminate
  ```
  
  输出结构：
  
  ```json
  {
      "state_machine": {
          "audiences": [
              {
                  "name": "public",
                  "type": "public"
              }
          ],
          "declarations": {
              "serviceStates": [
                  {
                      "name": "active",
                      "type": "authorization"
                  }
              ]
          },
          "states": {
              "initial": {
                  "transitions": [
                      {
                          "toState": "auth",
                          "service": "freelog",
                          "name": "RelativeTimeEvent",
                          "args": {
                              "elapsed": 1,
                              "timeUnit": "week"
                          },
                          "code": "A103",
                          "description": "fired when certain amount of time elapsed",
                          "isSingleton": false
                      }
                  ],
                  "serviceStates": [
                      "active"
                  ],
                  "isInitial": true
              },
              "auth": {
                  "transitions": [
                      {
                          "toState": "auth_month",
                          "service": "freelog",
                          "name": "TransactionEvent",
                          "args": {
                              "amount": 10,
                              "account": "self.account"
                          },
                          "code": "S201",
                          "description": "one time transaction",
                          "isSingleton": true
                      },
                      {
                          "toState": "auth_year",
                          "service": "freelog",
                          "name": "TransactionEvent",
                          "args": {
                              "amount": 100,
                              "account": "self.account"
                          },
                          "code": "S201",
                          "description": "one time transaction",
                          "isSingleton": true
                      },
                      {
                          "toState": "finish",
                          "service": "freelog",
                          "name": "RelativeTimeEvent",
                          "args": {
                              "elapsed": 3,
                              "timeUnit": "day"
                          },
                          "code": "A103",
                          "description": "fired when certain amount of time elapsed",
                          "isSingleton": false
                      }
                  ],
                  "serviceStates": []
              },
              "auth_month": {
                  "transitions": [
                      {
                          "toState": "finish",
                          "service": "freelog",
                          "name": "RelativeTimeEvent",
                          "args": {
                              "elapsed": 1,
                              "timeUnit": "month"
                          },
                          "code": "A103",
                          "description": "fired when certain amount of time elapsed",
                          "isSingleton": false
                      },
                      {
                          "toState": "auth_year",
                          "service": "freelog",
                          "name": "TransactionEvent",
                          "args": {
                              "amount": 100,
                              "account": "self.account"
                          },
                          "code": "S201",
                          "description": "one time transaction",
                          "isSingleton": true
                      }
                  ],
                  "serviceStates": [
                      "active"
                  ]
              },
              "auth_year": {
                  "transitions": [
                      {
                          "toState": "finish",
                          "service": "freelog",
                          "name": "RelativeTimeEvent",
                          "args": {
                              "elapsed": 1,
                              "timeUnit": "year"
                          },
                          "code": "A103",
                          "description": "fired when certain amount of time elapsed",
                          "isSingleton": false
                      }
                  ],
                  "serviceStates": [
                      "active"
                  ]
              },
              "finish": {
                  "transitions": [],
                  "serviceStates": []
              }
          },
          "description": {
              "symbolArgs": {
                  "envArgs": [
                      "self.account"
                  ]
              }
          }
      },
      "warnings": [],
      "warningObjects": [],
      "errors": [],
      "errorObjects": []
  }
  ```
  
  